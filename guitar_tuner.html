<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>ç›´è·³è°ƒå¼¦åŠ©æ‰‹</title>
  <style>
    body { font-family: sans-serif; padding: 16px; max-width: 480px; margin: auto; }
    .topbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 8px; }
    select, input, button { padding: 6px; font-size: 1rem; }
    #resultCard { border: 1px solid #ccc; padding: 12px; border-radius: 8px; margin-top: 12px; }
    table { width: 100%; border-collapse: collapse; margin: 8px 0; }
    th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
    tr:hover { background: #f5f5f5; cursor: pointer; }
    .warning { color: #b00; font-weight: bold; }
  </style>
</head>
<body>

  <div class="topbar">
    <div>ğŸ¸ ç›´è·³è°ƒå¼¦åŠ©æ‰‹</div>
    <div>â‹®</div>
  </div>

  <div class="controls">
    <div>
      <label>å½“å‰è°ƒå¼¦ A<br>
        <select id="fromPreset"></select>
      </label>
    </div>
    <div>
      <label>ç›®æ ‡è°ƒå¼¦ B<br>
        <select id="toPreset"></select>
      </label>
    </div>
    <div>
      <label>Capo è¯»æ•°<br>
        <input type="text" id="capo" readonly>
      </label>
    </div>
  </div>

  <button id="calculateBtn">ğŸ¯ è®¡ç®—ç›´è·³å·®å€¼</button>

  <div id="resultCard" style="display:none;">
    <p id="capoTarget"></p>
    <table id="deltaTable">
      <thead>
        <tr><th>å½“å‰â†’ç›®æ ‡</th><th>Â± åŠéŸ³</th></tr>
      </thead>
      <tbody></tbody>
    </table>
    <p id="tensionWarning" class="warning"></p>
    <button id="playSeqBtn">ğŸµ é¡ºåºæ’­æ”¾</button>
    <button id="playTapBtn">âœ‹ ç‚¹å¼¦æ’­æ”¾è¯´æ˜</button>
  </div>

  <script>
    // å¸¸é‡ä¸å†…ç½®é¢„ç½®
    const THRESHOLD = 6;  // Â±6 semitones
    const NOTE2NUM = { C:0,'C#':1,D:2,'D#':3,E:4,F:5,'F#':6,G:7,'G#':8,A:9,'A#':10,B:11 };
    const DEFAULT_PRESETS = [
      { id:'standard', title:'Standard', capo:0, tuning:['E2','A2','D3','G3','B3','E4'] },
      { id:'drifting', title:'æµè¡Œçš„äº‘', capo:0, tuning:['C2','G2','D3','G3','A3','D4'] },
      { id:'shooting', title:'æµæ˜Ÿ', capo:0, tuning:['D2','A2','G3','D3','G3','C4'] },
      { id:'hana',title:'èŠ±', capo: 3, tuning: ['D2','A2','D3','F#3','A3','D4'] },
      { id:'snowfall', title:'Snowfall', capo:0, tuning:['D2','A2','D3','G3','A3','D4'] }
    ];

    // ä» localStorage è¯»å–æˆ–åˆå§‹åŒ–
    function loadSongs(){
      let stored = localStorage.getItem('songs');
      return stored ? JSON.parse(stored) : DEFAULT_PRESETS;
    }
    function saveSongs(songs){
      localStorage.setItem('songs', JSON.stringify(songs));
    }

    // å¡«å……ä¸‹æ‹‰åˆ—è¡¨
    function populateSelects(){
      const songs = loadSongs();
      ['fromPreset','toPreset'].forEach(id=>{
        const sel = document.getElementById(id);
        sel.innerHTML = '';
        songs.forEach(s=>{
          let opt = new Option(s.title, s.id);
          sel.add(opt);
        });
        sel.add(new Option('+ æ–°å»ºæ›²ç›®â€¦', '_new'));
      });
      // é»˜è®¤é€‰ä¸­ standard
      document.getElementById('fromPreset').value = 'standard';
      document.getElementById('toPreset').value = 'standard';
      updateCapo();
    }

    // å¤„ç†â€œæ–°å»ºæ›²ç›®â€
    function tryAddNew(selectId){
      const sel = document.getElementById(selectId);
      if(sel.value !== '_new') return false;
      let title = prompt('æ–°å»ºæ›²ç›®åç§°ï¼ˆè‹±æ–‡/æ‹¼éŸ³ï¼‰:');
      if(!title) { sel.value = 'standard'; return true; }
      let tuning = prompt('è¯·è¾“å…¥ 6 ä¸ªéŸ³ï¼Œç”¨é€—å·åˆ†éš”ï¼Œä¾‹å¦‚ D2,A2,D3,G3,A3,D4 :');
      let capo = parseInt(prompt('Capo è¯»æ•°ï¼ˆ0 è¡¨ç¤ºæ— ï¼‰:'),10) || 0;
      const songs = loadSongs();
      const id = title.toLowerCase().replace(/\s+/g,'-');
      songs.push({ id, title, capo, tuning:tuning.split(',').map(s=>s.trim()) });
      saveSongs(songs);
      populateSelects();
      // é€‰ä¸­æ–°æ›²ç›®
      document.getElementById(selectId).value = id;
      return true;
    }

    // æ›´æ–° Capo æ˜¾ç¤º
    function updateCapo(){
      const songs = loadSongs();
      const toId = document.getElementById('toPreset').value;
      const song = songs.find(s=>s.id===toId);
      document.getElementById('capo').value = song ? 'Capo ' + song.capo : '';
    }

    // æå–éŸ³åï¼ˆå»é™¤å…«åº¦ï¼‰
    function notePart(str){
      return str.slice(1,2)==='#' ? str.slice(0,2) : str.charAt(0);
    }

    // è®¡ç®— delta
    function computeDelta(fromArr, toArr){
      return fromArr.map((fa,i)=>{
        let a = NOTE2NUM[notePart(fa)];
        let b = NOTE2NUM[notePart(toArr[i])];
        let d = (b - a + 12) % 12;
        if(d > 6) d -= 12;
        return d;
      });
    }

    // æ’­æ”¾ä¸€ä¸ªéŸ³
    function playNote(noteStr){
      // è§£æéŸ³ç¬¦å­—ç¬¦ä¸²ï¼Œæ ¼å¼ä¸º: éŸ³å(å¯å¸¦#) + å…«åº¦æ•°ï¼Œå¦‚ A4, C#3
      let match = noteStr.match(/^([A-G]#?)(\d)$/);
      if(!match) return;
      
      // æå–éŸ³åå’Œå…«åº¦æ•°
      let [_, note, oct] = match;
      
      // è®¡ç®—MIDIéŸ³ç¬¦å·(0-127)
      // NOTE2NUM å°†éŸ³åè½¬ä¸º 0-11 çš„æ•°å­—ï¼Œ+1 æ˜¯å› ä¸ºMIDIä»C-1å¼€å§‹è®°
      let midi = NOTE2NUM[note] + (parseInt(oct,10)+1)*12;
      
      // è®¡ç®—é¢‘ç‡(Hz)ï¼šæ ‡å‡†A4=440Hzï¼Œæ¯å‡/é™åŠéŸ³å˜åŒ– 2^(1/12)
      let freq = 440 * Math.pow(2, (midi - 69)/12);
      
      // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      
      // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹
      const osc = ctx.createOscillator();  // æŒ¯è¡å™¨
      const gain = ctx.createGain();       // éŸ³é‡æ§åˆ¶
      const filter = ctx.createBiquadFilter(); // æ»¤æ³¢å™¨
      
      // è®¾ç½®æ°‘è°£å‰ä»–éŸ³è‰²å‚æ•°
      osc.type = 'triangle';  // ä½¿ç”¨ä¸‰è§’æ³¢ä½œä¸ºåŸºç¡€æ³¢å½¢
      filter.type = 'lowpass';
      filter.frequency.value = 2000;
      filter.Q.value = 1;
      
      // è¿æ¥èŠ‚ç‚¹é“¾: æŒ¯è¡å™¨ -> æ»¤æ³¢å™¨ -> éŸ³é‡æ§åˆ¶ -> è¾“å‡º
      osc.connect(filter);
      filter.connect(gain);
      gain.connect(ctx.destination);
      
      // è®¾ç½®é¢‘ç‡
      osc.frequency.value = freq;
      
      // è®¾ç½®åŒ…ç»œ
      gain.gain.setValueAtTime(0, ctx.currentTime);
      gain.gain.linearRampToValueAtTime(0.8, ctx.currentTime + 0.01);  // å¿«é€Ÿèµ·éŸ³
      gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 1.5);  // ç¼“æ…¢è¡°å‡
      
      // å¼€å§‹æ’­æ”¾
      osc.start();
      osc.stop(ctx.currentTime + 2);
    }
    // é¡ºåºæ’­æ”¾
    function playSequential(arr){
      arr.forEach((n,i)=>{
        setTimeout(()=> playNote(n), i * 1000);
      });
    }

    // ç‚¹å‡»æ’­æ”¾å•å¼¦ï¼šå·²ç”±è¡Œç›‘å¬å®ç°

    // ç»‘å®šäº‹ä»¶
    window.onload = ()=>{
      populateSelects();
      ['fromPreset','toPreset'].forEach(id=>{
        document.getElementById(id).addEventListener('change', e=>{
          if(tryAddNew(id)) return;
          if(id==='toPreset') updateCapo();
        });
      });

      document.getElementById('calculateBtn').onclick = ()=>{
        const songs = loadSongs();
        const from = songs.find(s=>s.id===document.getElementById('fromPreset').value);
        const to   = songs.find(s=>s.id===document.getElementById('toPreset').value);
        if(!from||!to) return;

        const deltas = computeDelta(from.tuning, to.tuning);
        // æ¸²æŸ“è¡¨æ ¼
        let tbody = document.querySelector('#deltaTable tbody');
        tbody.innerHTML = '';
        deltas.forEach((d,i)=>{
          let tr = document.createElement('tr');
          let cur = notePart(from.tuning[i]), tgt = notePart(to.tuning[i]);
          tr.innerHTML = `<td>${cur}â†’${tgt}</td><td>${d>0? 'â†‘'+d : d<0? 'â†“'+(-d) : '0'}</td>`;
          tr.onclick = ()=> playNote(to.tuning[i]);
          tbody.appendChild(tr);
        });
        // è­¦å‘Š
        let warn = deltas.map((d,i)=> Math.abs(d)>THRESHOLD? `${i+1}å¼¦${d>0?'â†‘'+d:'â†“'+(-d)}` : '')
                         .filter(Boolean).join('ï¼Œ');
        document.getElementById('tensionWarning').textContent =
          warn? `âš  ${warn} (>Â±${THRESHOLD} åŠéŸ³) â€” è¯·ç•™æ„å¼ åŠ›` : '';
        // æ˜¾ç¤ºç»“æœ
        document.getElementById('capoTarget').textContent = `Capo ç›®æ ‡: ${to.capo}`;
        document.getElementById('resultCard').style.display = 'block';
        // ç»‘å®šæ’­æ”¾
        document.getElementById('playSeqBtn').onclick = ()=> playSequential(to.tuning);
      };

      document.getElementById('playTapBtn').onclick = ()=>{
        alert('å·²å¯ç”¨ç‚¹å¼¦æ’­æ”¾ï¼šç‚¹å‡»è¡¨æ ¼ä»»æ„è¡Œå¯æ’­æ”¾å¯¹åº”å¼¦éŸ³');
      };
    };
  </script>

</body>
</html>
